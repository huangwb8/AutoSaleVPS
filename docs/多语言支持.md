# AutoSaleVPS 多语言支持方案

## 目标与现状
- **目标**：在保留简体中文为默认语言的同时，为英语（en_US）、印地语（hi_IN）、西班牙语（es_ES）和法语（fr_FR）提供完整的 UI 文案、后台提示、默认示例以及日志输出的本地化。
- **现状**：所有字符串（PHP + TS）都写死为中文，插件头部缺少 text domain 定义，也没有 `languages/` 目录、`.po/.mo` 文件或 JS 端翻译基础设施；因此 WordPress 无法根据站点语言切换文本。

## 实施总览
1. **WordPress/PHP 层国际化**：声明 Text Domain、加载语言包、将 PHP 输出的字符串包裹在 `__()`/`esc_html__()` 等函数中，并将语言包放在 `languages/` 目录。
2. **前端（Vite + TypeScript）国际化**：通过 `@wordpress/i18n` 暴露的 `__` 函数在打包 JS 中读取同一套语言包，保证挂在 `wp.i18n` 上的翻译与 `wp_set_script_translations()` 对齐。
3. **多语言资源生成与目录结构**：维护 `.pot` 模板，生成 `autosalevps-<locale>.po/.mo` 与 `autosalevps-<locale>-<hash>.json`（JS 使用）。所有语言都由 WordPress 的 `wp i18n` CLI 生成，进入 git 以便打包分发。
4. **运行时语言选择**：沿用 WordPress 站点语言与后台用户语言（`determine_locale()`）；无需额外设置页面。

## 详细步骤

### 1. PHP/WordPress 层
1. **声明 Text Domain**：在 `autosalevps.php` 头部添加 `Text Domain: autosalevps` 与 `Domain Path: /languages`。
2. **加载语言包**：插件注册时调用 `load_plugin_textdomain( 'autosalevps', false, dirname( plugin_basename( __FILE__ ) ) . '/languages' );`，建议挂在 `init` 或 `plugins_loaded`。
3. **包裹所有字符串**：
   - 菜单标题、`add_shortcode` 输出、`wp_localize_script` 里的提示、REST 错误信息等全部改为 `__( 'AutoSaleVPS', 'autosalevps' )` 形式。
   - 对于 HTML 输出，使用 `esc_html__` / `esc_attr__`，并注意 `printf` 占位符。
4. **菜单和设置页**：`add_menu_page` 的 `page_title`、`menu_title` 及 `capability` 提示都使用翻译函数，这样后台语言就能独立切换。
5. **REST 层错误**：`WP_Error` 信息与日志提示同样使用 `__()`，以便前端收到本地化字符串。
6. **生成 POT 文件**：运行 `npx wp i18n make-pot . languages/autosalevps.pot --exclude=node_modules,vendor,assets`。保持 `composer.json`/`package.json` 中的脚本以便自动化。

### 2. 前端（TypeScript）层
1. **依赖与打包设置**：
   - 安装 `@wordpress/i18n` 为依赖。
   - 在 `vite.config.ts` 的 `build.rollupOptions.external` 中标记 `@wordpress/i18n`，并设置 `output.globals = { '@wordpress/i18n': 'wp.i18n' }`，防止 Vite 将其打包到文件中。
   - 在 WordPress 注册脚本时增加依赖 `array( 'wp-i18n' )` 以确保 `wp.i18n` 可用。
2. **封装翻译助手**：新增 `src/i18n.ts`（或 `src/core/i18n.ts`）导出 `t = ( text: string, context?: string ) => __( text, 'autosalevps' )`，并在 `ASVApp`、`ASVModal`、`ASVLogPanel`、`src/main.ts` 等文件引入，用翻译函数替换硬编码中文。
3. **静态模板与提示**：`config.toml`、`model.toml`、`EXTRA_CSS_TEMPLATE`、日志消息、按钮、状态 pill、提示文本、错误提示等全部切换为翻译 key。必要时引入 `sprintf`（`@wordpress/i18n` 提供）处理变量插值。
4. **脚本翻译文件**：
   - 执行 `npx wp i18n make-json languages --no-purge` 生成 JS 可读的 `*.json`。
   - 在 `register_assets()` 中调用 `wp_set_script_translations( 'autosalevps-app', 'autosalevps', plugin_dir_path( __FILE__ ) . 'languages' );`。
5. **日志/通知本地化**：REST 返回的字符串已经本地化后，JS 端某些动态拼接消息（如“${vendor} ${pid} 推广语已保存”）应改为占位符：`sprintf( __( '%1$s %2$s 推广语已保存', 'autosalevps' ), vendor, pid )`。

### 3. 语言资源组织
```
languages/
  autosalevps.pot                # 模板
  autosalevps-zh_CN.po/.mo       # 默认中文
  autosalevps-en_US.po/.mo       # 英语
  autosalevps-hi_IN.po/.mo       # 印地语
  autosalevps-es_ES.po/.mo       # 西班牙语
  autosalevps-fr_FR.po/.mo       # 法语
  autosalevps-zh_CN-<hash>.json  # JS 端
  ...
```
- `.po` 文件由翻译平台（Poedit、Loco Translate、GlotPress）维护，`.mo` 由编译脚本生成。
- JS 端 `json` 文件由 `wp i18n make-json` 自动生成，不手写。
- 打包 `npm run package` 时 `languages` 目录会被包含进 ZIP，这样 WordPress 可直接识别。

### 4. 运行时语言选择策略
1. WordPress 将按照站点语言（前台）与用户语言（后台）调用 `get_locale()` / `get_user_locale()`，我们不需要自建“语言切换”设置。
2. PHP 端输出/REST 响应会自动根据当前 locale 选用 `.mo` 文件；前端 JS 则因 `wp_set_script_translations` 与 `wp-i18n` 同步而显示相同语言。
3. 若某个字符串丢失翻译，`__()` 会回退到原文（简体中文），保证功能可用。

### 5. 模型提示与配置模板
- `model.toml` 中的默认 prompt 目前为中文，可按语言拆分：
  1. 在 `config.toml` 里新增 `ui.language = 'zh_CN'` 之类的选项，或继续沿用站点语言。
  2. 根据语言选择不同 prompt 模板（例如在 `ASV_Meta_Service`/`ASV_Promo_Service` 里根据 locale 注入英文或法文 prompt）。
- 在文档中提示用户：如需在单站点内撰写多语言推广内容，应该在 TOML 中单独配置不同 vendor/pid 的 `human_comment`、`meta_display` 等文案。

## 建议的任务拆分
1. **基础设施**：添加 Text Domain、`load_plugin_textdomain`、`wp_set_script_translations`，创建 `languages/` 目录与 `scripts/i18n`（可在 npm scripts 中封装 make-pot/make-json）。
2. **PHP 字符串国际化**：遍历 `autosalevps.php` 与 `src/php/` 内的类，将硬编码中文替换为翻译函数。
3. **前端字符串国际化**：在 TS 中引入 `@wordpress/i18n`，创建 `t()` helper，并替换所有中文常量。
4. **生成语言文件**：先完成 zh_CN/English，确认流程无误后再补 hi_IN/es_ES/fr_FR。
5. **文案校对**：请专业译者或使用 LLM 初稿后人工校对，确保菜单、提示语、日志、默认模板都自然贴切。

遵循以上步骤即可在当前架构下实现多语言支持，同时保证 `npm run build`、`npm run package` 输出的 ZIP 带有完整翻译文件，上传即用。
